<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pet Farm Clicker</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script type="module">
    // ------------------- Firebase Imports & Init -------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import {
        getFirestore, doc, getDoc, onSnapshot, setDoc, updateDoc,
        increment, collection, query, where, getDocs, writeBatch, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyARZvFpMMn5t8pg5gb2bWA6OrZC1L8DBSA",
        authDomain: "my-pet-c8684.firebaseapp.com",
        projectId: "my-pet-c8684",
        storageBucket: "my-pet-c8684.firebasestorage.app",
        messagingSenderId: "102742166711",
        appId: "1:102742166711:web:aa6b251fd6d6c993c71132"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ------------------- Global State -------------------
    const CURRENT_UPDATE_VERSION = '3.0.0';
    const PASSIVE_TICK_RATE = 1000;
    const SOUND_COOLDOWN = 150;
    let passiveIntervalId = null;
    let lastSoundTime = 0;
    let currentCaseId = 'farmer';
    let currentUserId = null;
    let presenceIntervalId = null;

    window.gameState = {
        paws: 0.00,
        baseClickValue: 0.09,
        inventory: [],
        isDbReady: false,
        selectedPets: [],
        passiveRate: 0.00,
        upgrades: { equippedPetsLevel: 0 },
        foundPets: [],
        isCollectionRewardClaimed: false,
        // trade state local copy
        activeTrade: null
    };

    // ------------------- Sample Items -------------------
    const FARMER_CASE_ITEMS = [
        { name: "Собака", rarity: "Обычный", border: "border-gray-400", color: "text-gray-400", weight: 35.00, icon: "https://files.catbox.moe/nccx9g.png", value: 25.00, passiveValue: 0.08 },
        { name: "Овца", rarity: "Обычный", border: "border-gray-400", color: "text-gray-400", weight: 35.00, icon: "https://files.catbox.moe/v2hob0.png", value: 40.00, passiveValue: 0.10 },
        { name: "Корова", rarity: "Необычный", border: "border-blue-500", color: "text-blue-500", weight: 10.00, icon: "https://files.catbox.moe/o08ewe.png", value: 60.00, passiveValue: 0.13 },
        { name: "Радугобар", rarity: "Секретный", border: "border-rainbow", color: "text-orange-400", weight: 0.25, icon: "https://files.catbox.moe/42dehy.png", value: 1000.00, passiveValue: 1.11, isHiddenInPreview: true, previewName: "Секретный", previewIcon: "https://placehold.co/60x60/374151/fff?text=?" }
    ];

    const JUNGLE_CASE_ITEMS = [
        { name: "Жук", rarity: "Обычный", border: "border-gray-400", color: "text-gray-400", weight: 34.975, icon: "https://files.catbox.moe/r8hzet.jpg", value: 250.00, passiveValue: 0.80 },
        { name: "Пантера", rarity: "Секретный", border: "border-rainbow", color: "text-orange-400", weight: 0.125, icon: "https://files.catbox.moe/gkav13.jpg", value: 10000.00, passiveValue: 9.00, isHiddenInPreview: true, previewName: "Секретный", previewIcon: "https://placehold.co/60x60/374151/fff?text=?" },
    ];

    const CASES = {
        farmer: { name: "Фермерский Кейс", cost: 100.00, items: FARMER_CASE_ITEMS, totalWeight: FARMER_CASE_ITEMS.reduce((s,i)=>s+i.weight,0) },
        jungle: { name: "Джунглийский Кейс", cost: 2000.00, items: JUNGLE_CASE_ITEMS, totalWeight: JUNGLE_CASE_ITEMS.reduce((s,i)=>s+i.weight,0) },
    };

    const ALL_PETS = [...new Map([...FARMER_CASE_ITEMS, ...JUNGLE_CASE_ITEMS].map(i=>[i.name,i])).values()];
    const COLLECTION_REWARD = 22222;

    function getMaxSelectedPets(){
        const level = window.gameState.upgrades.equippedPetsLevel;
        if(level === 1) return 4;
        if(level === 2) return 5;
        return 3;
    }

    // ------------------- Audio (kept minimal) -------------------
    let clickPlayer, navClickSynth, reelTickSynth, isMusicPlaying=false;
    try{ clickPlayer = new Tone.PluckSynth().toDestination(); clickPlayer.volume.value = -10; }catch(e){}
    try{ navClickSynth = new Tone.MembraneSynth().toDestination(); navClickSynth.volume.value = -12; }catch(e){}
    try{ reelTickSynth = new Tone.Synth().toDestination(); reelTickSynth.volume.value = -18; }catch(e){}

    function playNavClickSound(){
        const now = Date.now();
        if(now - lastSoundTime < SOUND_COOLDOWN) return;
        lastSoundTime = now;
        if(navClickSynth && Tone.context.state === 'running'){
            try { navClickSynth.triggerAttackRelease("G5","16n"); }catch(e){}
        }
    }
    function playMusic(){ const audio=document.getElementById('backgroundMusic'); if(!isMusicPlaying){ audio.volume=0.2; audio.play().then(()=>isMusicPlaying=true).catch(()=>{}); } }

    // ------------------- Local Save/Load -------------------
    async function loadGameState(){
        try {
            window.gameState.paws = parseFloat(localStorage.getItem('petFarmPaws')) || 0.00;
            window.gameState.inventory = JSON.parse(localStorage.getItem('petFarmInventory')||'[]');
            window.gameState.selectedPets = JSON.parse(localStorage.getItem('petFarmSelectedPets')||'[]');
            window.gameState.upgrades = JSON.parse(localStorage.getItem('petFarmUpgrades')||'{"equippedPetsLevel":0}');
            window.gameState.foundPets = JSON.parse(localStorage.getItem('petFarmFoundPets')||'[]');
            window.gameState.isCollectionRewardClaimed = JSON.parse(localStorage.getItem('petFarmCollectionRewardClaimed')||'false');
        } catch(e){ console.error("Ошибка загрузки local:",e); window.gameState = Object.assign(window.gameState,{paws:0,inventory:[],selectedPets:[],upgrades:{equippedPetsLevel:0},foundPets:[],isCollectionRewardClaimed:false}); }
    }
    async function saveGameState(){
        try {
            localStorage.setItem('petFarmPaws', window.gameState.paws.toFixed(2));
            localStorage.setItem('petFarmInventory', JSON.stringify(window.gameState.inventory));
            localStorage.setItem('petFarmSelectedPets', JSON.stringify(window.gameState.selectedPets));
            localStorage.setItem('petFarmUpgrades', JSON.stringify(window.gameState.upgrades));
            localStorage.setItem('petFarmFoundPets', JSON.stringify(window.gameState.foundPets));
            localStorage.setItem('petFarmCollectionRewardClaimed', JSON.stringify(window.gameState.isCollectionRewardClaimed));

            if(currentUserId){
                const playerRef = doc(db,"players", currentUserId);
                await setDoc(playerRef, {
                    paws: window.gameState.paws,
                    inventory: window.gameState.inventory,
                    lastSeen: serverTimestamp()
                }, { merge: true });
            }
        } catch(e){ console.error("Ошибка сохранения:", e); }
    }

    function migrateInventory(){
        const master = new Map(ALL_PETS.map(i=>[i.name,i]));
        let changed=false;
        window.gameState.inventory = window.gameState.inventory.map(p=>{
            const m=master.get(p.name);
            if(m){
                ['passiveValue','border','color','rarity','value','clickBonus','icon'].forEach(prop=>{ if(p[prop]!==m[prop]) p[prop]=m[prop]; });
                changed=true;
            }
            return p;
        });
        if(changed){ saveGameState(); }
    }

    // ------------------- UI helpers -------------------
    function showToast(text){
        const t = document.getElementById('notification-modal');
        document.getElementById('notification-text').textContent = text;
        t.style.display = 'flex';
        setTimeout(()=>t.style.display='none',3000);
    }
    function updateClickValueDisplay(){ document.getElementById('click-power-display').textContent = `Сила клика: ${calculateClickValue().toFixed(2)}`; }
    function updatePawsDisplay(){
        const rate = calculatePassiveRate();
        document.getElementById('paws-display').textContent = `Лапки: ${window.gameState.paws.toFixed(2)}`;
        document.getElementById('passive-rate-display').textContent = `Авто: +${rate.toFixed(2)} / с`;
        updateClickValueDisplay();
        // refresh case details preview if open:
        const caseSection = document.getElementById('case-details-section');
        if(caseSection && caseSection.style.display !== 'none'){ window.showCaseDetails(currentCaseId,true); }
    }
    function updateAppState(isReady){
        const clickButton = document.getElementById('click-button');
        const loadingMessage = document.getElementById('loading-message');
        const clickMessage = document.getElementById('click-message');
        if(isReady){
            clickButton.disabled=false;
            loadingMessage.style.display='none';
            clickMessage.style.display='block';
            clickButton.classList.remove('opacity-50','cursor-not-allowed','bg-gray-600');
            clickButton.classList.add('bg-orange-500','hover:bg-orange-400','hover:shadow-xl');
        } else {
            clickButton.disabled=true;
            loadingMessage.style.display='block';
            clickMessage.style.display='none';
            clickButton.classList.remove('bg-orange-500','hover:bg-orange-400','hover:shadow-xl');
            clickButton.classList.add('opacity-50','cursor-not-allowed','bg-gray-600');
        }
    }

    // ------------------- Click / Passive Calculations -------------------
    function calculateClickValue(){
        let bonus=0;
        const active = window.gameState.inventory.filter(p=>window.gameState.selectedPets.includes(p.id));
        active.forEach(p=>{ if(p.clickBonus) bonus+=p.clickBonus; });
        return window.gameState.baseClickValue + bonus;
    }
    function calculatePassiveRate(){
        let total=0;
        const active = window.gameState.inventory.filter(p=>window.gameState.selectedPets.includes(p.id));
        active.forEach(p=>{ if(p.passiveValue) total+=p.passiveValue; });
        window.gameState.passiveRate = total;
        return total;
    }

    // ------------------- Inventory rendering -------------------
    function getIconHtml(item, size='w-10 h-10', extra='mr-3'){
        if(!item) return '';
        if(item.isMegaSecret) return '<div class="w-full h-full flex items-center justify-center text-4xl font-black text-white">?</div>';
        const url = item.icon && item.icon.startsWith('http') ? item.icon : 'https://placehold.co/60x60/374151/fff?text=?';
        return `<img src="${url}" alt="${item.name}" class="${size} ${extra} object-cover bg-gray-700 rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/40x40/374151/fff?text=?';">`;
    }

    function renderInventory(){
        const container = document.getElementById('inventory-container');
        const empty = document.getElementById('inventory-empty-state');
        document.getElementById('active-pets-count').textContent = `Активных: ${window.gameState.selectedPets.length} / ${getMaxSelectedPets()}`;
        if(!window.gameState.inventory || window.gameState.inventory.length===0){
            empty.style.display='flex';
            container.innerHTML='';
            return;
        }
        empty.style.display='none';
        container.innerHTML = [...window.gameState.inventory].reverse().map(item=>{
            const isSelected = window.gameState.selectedPets.includes(item.id);
            const hasBonus = (item.passiveValue && item.passiveValue>0) || (item.clickBonus && item.clickBonus>0);
            let btnClass='py-1 px-3 rounded-lg text-sm font-semibold transition-colors';
            let btnText='Выбрать';
            if(isSelected){ btnClass += ' bg-red-600 hover:bg-red-500'; btnText='Активен (Снять)'; }
            else if(hasBonus && window.gameState.selectedPets.length < getMaxSelectedPets()) { btnClass += ' bg-green-600 hover:bg-green-500'; }
            else if(hasBonus) { btnClass += ' bg-gray-600 cursor-not-allowed opacity-70'; btnText='Лимит'; }
            else { btnClass += ' bg-gray-600 cursor-not-allowed opacity-50'; btnText='Нет бонусов'; }
            const sellBtn = item.value ? `<button onclick="window.showSellConfirmation('${item.id}')" class="py-1 px-3 rounded-lg text-sm font-semibold bg-gray-500 hover:bg-gray-400">Продать (${item.value.toFixed(2)})</button>` : '';
            const passiveInfo = item.passiveValue ? `<p class="text-xs text-green-400 mt-1 font-bold">Доход: +${item.passiveValue.toFixed(2)}/с</p>` : '';
            const clickInfo = item.clickBonus ? `<p class="text-xs text-blue-400 mt-1 font-bold">Клик: +${item.clickBonus.toFixed(2)}</p>` : '';
            const noBonus = (!passiveInfo && !clickInfo) ? `<p class="text-xs text-gray-500 mt-1">Не дает бонусов</p>` : '';
            const secretClass = (item.rarity==='Секретный' || item.rarity==='Мега Секретный') ? 'inventory-item-secret' : '';
            return `<div class="inventory-item p-4 bg-gray-700 rounded-xl flex items-center justify-between shadow-lg border-l-4 ${item.border.replace('border-','border-l-')} ${secretClass}">
                <div class="flex items-center flex-grow cursor-pointer" onclick="window.showPetPreview('${item.id}','inventory')">
                    ${getIconHtml(item,'w-12 h-12','mr-4 flex-shrink-0')}
                    <div class="flex-grow">
                        <p class="text-lg font-bold ${item.color}">${item.name}</p>
                        <p class="text-sm text-gray-400">${item.rarity}</p>
                        ${passiveInfo}${clickInfo}${noBonus}
                    </div>
                </div>
                <div class="text-right flex-shrink-0 ml-4 flex flex-col space-y-2">
                    <button onclick="window.togglePetSelection('${item.id}')" class="${btnClass}" ${(!hasBonus || (!isSelected && window.gameState.selectedPets.length >= getMaxSelectedPets())) ? 'disabled' : ''}>${btnText}</button>
                    ${sellBtn}
                    <p class="text-xs text-gray-500 mt-2">${new Date(item.date).toLocaleDateString('ru-RU')}</p>
                </div>
            </div>`;
        }).join('');
    }

    // ------------------- Case preview & reels (kept from original) -------------------
    function renderCasePreview(caseId){
        const preview = document.getElementById('case-preview-container');
        preview.innerHTML='';
        const items = CASES[caseId].items.map(i=>({ ...i, probability:i.weight })).sort((a,b)=>b.probability-a.probability);
        items.forEach(item=>{
            if(item.isMegaSecret) return;
            const displayName = item.isHiddenInPreview ? item.previewName : item.name;
            const displayRarity = item.isHiddenInPreview ? "????" : item.rarity;
            const displayColor = item.isHiddenInPreview ? "text-gray-400" : item.color;
            preview.innerHTML += `<div class="preview-grid-item border-2 ${item.border} flex items-center p-3 rounded-lg bg-gray-900 shadow-md cursor-pointer hover:bg-gray-800" onclick="window.showPetPreview('${item.name}','case')">
                ${getIconHtml(item)}
                <div class="flex-grow"><p class="text-md font-bold ${displayColor} leading-tight">${displayName}</p><p class="text-xs text-gray-400">${displayRarity}</p></div>
                <p class="text-sm font-semibold text-right text-gray-300 ml-2 whitespace-nowrap">${item.probability.toFixed(2)}%</p>
            </div>`;
        });
    }

    function getWeightedRandomItem(caseId){
        const c = CASES[caseId];
        if(!c) return null;
        let r = Math.random() * c.totalWeight;
        for(const it of c.items){
            if(r < it.weight) return it;
            r -= it.weight;
        }
        return c.items[0];
    }

    // ------------------- UI Modals & Pet Preview -------------------
    window.showPetPreview = function(identifier, source){
        playNavClickSound();
        let petData;
        const isInventory = source === 'inventory';
        if(isInventory) petData = window.gameState.inventory.find(p=>p.id===identifier);
        else petData = ALL_PETS.find(p=>p.name===identifier);
        if(!petData) return showToast("Ошибка: Питомец не найден.");
        const modal = document.getElementById('pet-preview-modal');
        const content = document.getElementById('pet-preview-content');
        const img = document.getElementById('pet-preview-image');
        const nameEl = document.getElementById('pet-preview-name');
        const rarityEl = document.getElementById('pet-preview-rarity');
        const buttons = document.getElementById('pet-preview-buttons');

        const isHidden = !isInventory && petData.isHiddenInPreview;
        if(isHidden){
            img.src = petData.previewIcon;
            img.alt = "Секретный питомец";
            nameEl.textContent = petData.previewName || "?????";
            nameEl.className = "text-3xl font-extrabold mb-1 text-gray-400";
            rarityEl.textContent = "???";
            rarityEl.className = "text-lg mb-6 text-gray-400";
            content.className = 'p-8 rounded-2xl text-center w-full max-w-sm transition-all bg-gray-800';
        } else {
            img.src = petData.icon;
            img.alt = petData.name;
            nameEl.textContent = petData.name;
            nameEl.className = `text-3xl font-extrabold mb-1 ${petData.color}`;
            rarityEl.textContent = petData.rarity;
            rarityEl.className = `text-lg mb-6 ${petData.color}`;
            content.className = 'p-8 rounded-2xl text-center w-full max-w-sm transition-all bg-gray-800';
            if(petData.rarity === 'Секретный') content.classList.add('modal-secret-glow','bg-gray-900');
            if(petData.rarity === 'Мега Секретный') content.classList.add('modal-mega-secret-glow','bg-gray-900');
        }

        buttons.innerHTML='';
        if(isInventory){
            const isSelected = window.gameState.selectedPets.includes(petData.id);
            const hasBonus = petData.passiveValue > 0 || petData.clickBonus > 0;
            let selectClass = 'flex-1 py-3 font-bold rounded-xl transition-colors ';
            let selectText = 'Выбрать';
            let disabled=false;
            if(isSelected){ selectClass += ' bg-red-600 hover:bg-red-500 text-white'; selectText='Убрать'; }
            else if(hasBonus && window.gameState.selectedPets.length < getMaxSelectedPets()){ selectClass += ' bg-green-600 hover:bg-green-500 text-white'; }
            else if(hasBonus){ selectClass += ' bg-gray-600 text-gray-400 cursor-not-allowed'; selectText='Лимит'; disabled=true; }
            else { selectClass += ' bg-gray-600 text-gray-400 cursor-not-allowed'; selectText='Нет бонусов'; disabled=true; }
            buttons.innerHTML += `<button onclick="window.togglePetSelection('${petData.id}')" class="${selectClass}" ${disabled? 'disabled':''}>${selectText}</button>`;
            buttons.innerHTML += `<button onclick="window.showSellConfirmation('${petData.id}')" class="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-xl transition-colors ml-2">Продать</button>`;
        }

        modal.style.display='flex';
    }

    window.closePetPreview = function(){ playNavClickSound(); document.getElementById('pet-preview-modal').style.display='none'; }

    // ------------------- Equip / Sell / Reset -------------------
    window.equipBestPets = function(){
        playNavClickSound();
        const max = getMaxSelectedPets();
        const available = window.gameState.inventory.filter(p=>p.passiveValue>0);
        if(available.length===0) return showToast("У вас нет питомцев, приносящих доход!");
        available.sort((a,b)=>b.passiveValue - a.passiveValue);
        window.gameState.selectedPets = available.slice(0,max).map(p=>p.id);
        saveGameState();
        updatePawsDisplay();
        renderInventory();
        showToast(`✅ Выбраны ${window.gameState.selectedPets.length} лучших питомцев!`);
    }

    window.showSellConfirmation = function(petId){
        window.closePetPreview();
        playNavClickSound();
        const pet = window.gameState.inventory.find(p=>p.id===petId);
        if(!pet || pet.value===undefined) return showToast("Ошибка: Цена не найдена.");
        const modal = document.getElementById('sell-confirm-modal');
        document.getElementById('sell-pet-name').textContent = pet.name;
        document.getElementById('sell-pet-price').textContent = pet.value.toFixed(2);
        document.getElementById('sell-confirm-button').setAttribute('data-pet-id', petId);
        document.getElementById('sell-confirm-button').textContent = `Продать за ${pet.value.toFixed(2)} Лапок`;
        modal.style.display='flex';
    }
    window.performSell = function(){
        playNavClickSound();
        const petId = document.getElementById('sell-confirm-button').getAttribute('data-pet-id');
        document.getElementById('sell-confirm-modal').style.display='none';
        if(!petId) return showToast("Ошибка: ID питомца не найден.");
        const idx = window.gameState.inventory.findIndex(p=>p.id===petId);
        if(idx===-1) return showToast("Ошибка: Питомец не найден.");
        const pet = window.gameState.inventory[idx];
        window.gameState.paws += pet.value;
        window.gameState.selectedPets = window.gameState.selectedPets.filter(id=>id!==petId);
        window.gameState.inventory.splice(idx,1);
        saveGameState();
        updatePawsDisplay();
        renderInventory();
        showToast(`💰 Продано: ${pet.name} за ${pet.value.toFixed(2)} Лапок!`);
    }

    window.showResetConfirmation = function(){
        playNavClickSound();
        const modal = document.getElementById('reset-confirm-modal');
        const input = document.getElementById('reset-confirm-input');
        const btn = document.getElementById('reset-confirm-button');
        input.value='';
        btn.disabled=true;
        btn.classList.add('bg-red-800','text-gray-500','cursor-not-allowed');
        btn.classList.remove('bg-red-600','hover:bg-red-500');
        modal.style.display='flex';
    }
    window.performReset = function(){
        const input = document.getElementById('reset-confirm-input');
        if(input.value !== 'удалить данные') return showToast("Ошибка: Текст подтверждения неверен.");
        playNavClickSound();
        localStorage.clear();
        showToast("Сброс прогресса...");
        window.location.reload();
    }
    window.closeResetConfirmation = function(){ playNavClickSound(); document.getElementById('reset-confirm-modal').style.display='none'; }

    // ------------------- Collection -------------------
    window.showCollectionModal = function(){ playNavClickSound(); renderCollection(); document.getElementById('collection-modal').style.display='flex'; }
    window.claimCollectionReward = function(){
        playNavClickSound();
        if(window.gameState.foundPets.length < ALL_PETS.length) return showToast("Вы еще не собрали всех питомцев!");
        if(window.gameState.isCollectionRewardClaimed) return showToast("Награда уже получена.");
        window.gameState.paws += COLLECTION_REWARD;
        window.gameState.isCollectionRewardClaimed = true;
        saveGameState();
        updatePawsDisplay();
        renderCollection();
        showToast(`🎉 Вы получили ${COLLECTION_REWARD} Лапок за полную коллекцию!`);
    }
    function renderCollection(){
        const grid = document.getElementById('collection-grid');
        const counter = document.getElementById('collection-counter');
        const rewardBtn = document.getElementById('collection-reward-button');
        const found = window.gameState.foundPets.length;
        const total = ALL_PETS.length;
        counter.textContent = `Найдено: ${found} / ${total}`;
        grid.innerHTML='';
        ALL_PETS.forEach(p=>{
            const isFound = window.gameState.foundPets.includes(p.name);
            if(isFound){
                grid.innerHTML += `<div class="relative flex flex-col items-center justify-center p-2 rounded-lg bg-gray-700 border-2 ${p.border}"><img src="${p.icon}" class="w-16 h-16 object-cover rounded-md"><p class="mt-2 text-xs font-bold ${p.color} text-center truncate w-full">${p.name}</p><p class="text-xs ${p.color} opacity-70 text-center">${p.rarity}</p></div>`;
            } else {
                grid.innerHTML += `<div class="flex items-center justify-center p-2 rounded-lg bg-gray-900 aspect-square"><i class="fas fa-question text-4xl text-gray-700"></i></div>`;
            }
        });
        rewardBtn.className='w-full py-3 font-bold rounded-xl transition-all shadow-lg text-lg';
        if(window.gameState.isCollectionRewardClaimed){ rewardBtn.disabled=true; rewardBtn.textContent='Награда получена'; rewardBtn.classList.add('bg-green-700','text-gray-300','cursor-not-allowed'); }
        else if(found >= total){ rewardBtn.disabled=false; rewardBtn.textContent=`Забрать ${COLLECTION_REWARD.toLocaleString('ru-RU')} Лапок`; rewardBtn.classList.add('bg-yellow-500','hover:bg-yellow-400','text-gray-900'); }
        else { rewardBtn.disabled=true; rewardBtn.textContent='Соберите всех питомцев'; rewardBtn.classList.add('bg-gray-600','text-gray-400','cursor-not-allowed'); }
    }

    // ------------------- Players List & Inspect (fixed getDoc usage) -------------------
    window.showPlayersModal = async function(){
        playNavClickSound();
        document.getElementById('players-modal').style.display='flex';
        const container = document.getElementById('players-list-container');
        container.innerHTML = '<p class="text-gray-400">Загрузка игроков...</p>';
        try{
            const fiveMin = new Date(Date.now() - 5*60*1000);
            const q = query(collection(db,"players"), where("lastSeen", ">", fiveMin));
            const snap = await getDocs(q);
            let html='';
            snap.forEach(d=>{
                if(d.id === currentUserId) return;
                const pdata = d.data();
                html += `<div class="bg-gray-700 p-4 rounded-xl flex items-center justify-between mb-2">
                    <div class="flex flex-col">
                        <p class="font-bold text-white truncate w-32" title="${d.id}">Игрок: ${d.id.substring(0,8)}...</p>
                        <p class="text-sm text-green-400">В сети</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="window.inspectPlayer('${d.id}')" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-bold"><i class="fas fa-eye"></i></button>
                        <button onclick="window.initiateTrade('${d.id}')" class="px-3 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg text-sm font-bold"><i class="fas fa-exchange-alt mr-1"></i>Обмен</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html || '<p class="text-gray-400 text-center">Сейчас нет других игроков в сети.</p>';
        } catch(e){ console.error("Error fetching players:",e); container.innerHTML='<p class="text-red-400">Ошибка загрузки списка игроков.</p>'; }
    }

    window.closePlayersModal = function(){ playNavClickSound(); document.getElementById('players-modal').style.display='none'; }

    // Inspect a player's inventory (fixed)
    window.inspectPlayer = async function(playerId){
        playNavClickSound();
        const modal = document.getElementById('player-inspect-modal');
        const container = document.getElementById('player-inspect-container');
        container.innerHTML = '<p>Загрузка...</p>';
        modal.style.display='flex';
        try{
            const playerRef = doc(db,"players",playerId);
            const playerSnap = await getDoc(playerRef); // correct
            if(playerSnap.exists()){
                const pdata = playerSnap.data();
                document.getElementById('player-inspect-name').textContent = `Игрок: ${playerId.substring(0,8)}...`;
                document.getElementById('player-inspect-paws').textContent = `Лапки: ${pdata.paws ? Number(pdata.paws).toFixed(2) : '0.00'}`;
                let invHtml = '';
                if(pdata.inventory && pdata.inventory.length > 0){
                    invHtml = pdata.inventory.map(pet => `<div class="p-2 bg-gray-900 rounded-lg flex items-center border-l-4 ${pet.border.replace('border-','border-l-')} mb-2">${getIconHtml(pet,'w-10 h-10','flex-shrink-0 mr-3')}<div><p class="font-bold text-sm ${pet.color}">${pet.name}</p><p class="text-xs text-gray-400">${pet.rarity}</p></div></div>`).join('');
                } else {
                    invHtml = '<p class="text-gray-500 text-center">Инвентарь пуст</p>';
                }
                container.innerHTML = invHtml;
            } else {
                container.innerHTML = '<p class="text-red-400">Не удалось найти данные игрока.</p>';
            }
        } catch(e){ console.error("Error inspecting player:",e); container.innerHTML = '<p class="text-red-400">Ошибка при загрузке инвентаря.</p>'; }
    }
    window.closeInspectModal = function(){ playNavClickSound(); document.getElementById('player-inspect-modal').style.display='none'; }

    // ------------------- Trading: initiateTrade, trade modal, accept/cancel -------------------
    // Basic flow:
    // - initiateTrade(otherId) -> create trade doc in Firestore "trades" with status "pending", offers empty
    // - openTradeModal shows a local UI where user can pick own pets + add paws
    // - send updates to trade doc; other side listens and sees offers
    // - both press "Согласен" -> trade executes (swap inventory entries + paws transfer) and trade doc set status "completed"

    async function ensurePlayerDoc(){
        if(!currentUserId) return;
        const pref = doc(db,"players",currentUserId);
        try{
            const snap = await getDoc(pref);
            if(!snap.exists()){
                await setDoc(pref,{ paws: window.gameState.paws, inventory: window.gameState.inventory, lastSeen: serverTimestamp() });
            }
        }catch(e){ console.error("ensurePlayerDoc err",e); }
    }

    async function initiateTrade(otherId){
        playNavClickSound();
        if(!otherId) return;
        // create trade doc with generated id:
        const tradeId = crypto.randomUUID();
        const tradeRef = doc(db,"trades",tradeId);
        const tradePayload = {
            createdAt: serverTimestamp(),
            status: "pending",
            initiator: currentUserId,
            responder: otherId,
            initiatorOffer: { pets: [], paws: 0 },
            responderOffer: { pets: [], paws: 0 },
            initiatorReady: false,
            responderReady: false
        };
        try{
            await setDoc(tradeRef, tradePayload);
            // open local trade UI as initiator
            openTradeModal(tradeId, true, otherId);
            // set up listener for changes to trade
            listenToTrade(tradeId);
        } catch(e){ console.error("initiateTrade err",e); showToast("Не удалось создать запрос обмена."); }
    }

    function listenToTrade(tradeId){
        const tradeRef = doc(db,"trades",tradeId);
        // remove previous listener if any
        if(window.currentTradeUnsub) window.currentTradeUnsub();
        window.currentTradeUnsub = onSnapshot(tradeRef, snap=>{
            if(!snap.exists) return;
            const data = snap.data();
            // update local UI if modal open
            if(document.getElementById('trade-modal').style.display === 'flex' && window.gameState.activeTrade && window.gameState.activeTrade.tradeId === tradeId){
                // update the trade panel
                updateTradeUIFromData(data);
            }
            // if trade completed, close and apply changes locally
            if(data.status === 'completed'){
                showToast('Обмен завершён!');
                // stop listening
                if(window.currentTradeUnsub) window.currentTradeUnsub();
                window.currentTradeUnsub = null;
                // refresh local state (we saved after apply)
                loadGameState().then(()=>{ renderInventory(); updatePawsDisplay(); });
                // close modal
                document.getElementById('trade-modal').style.display='none';
            }
            if(data.status === 'cancelled'){
                showToast('Обмен отменён.');
                if(window.currentTradeUnsub) window.currentTradeUnsub();
                window.currentTradeUnsub=null;
                document.getElementById('trade-modal').style.display='none';
            }
        }, err => console.error("trade snapshot err",err));
    }

    function openTradeModal(tradeId, amInitiator, otherId){
        playNavClickSound();
        // prepare local trade state
        window.gameState.activeTrade = {
            tradeId,
            amInitiator,
            withUser: otherId,
            myOffer: { pets: [], paws: 0 },
            theirOffer: { pets: [], paws: 0 },
            myReady: false,
            theirReady: false
        };
        // populate UI
        document.getElementById('trade-with-name').textContent = `Обмен с: ${otherId.substring(0,8)}...`;
        // render my pets for selection
        const myPetsContainer = document.getElementById('trade-my-pets');
        myPetsContainer.innerHTML = window.gameState.inventory.map(p=>`<div class="p-2 bg-gray-800 rounded-lg flex items-center justify-between mb-2">
            <div class="flex items-center">${getIconHtml(p,'w-10 h-10','mr-3')}<div><p class="font-bold text-sm ${p.color}">${p.name}</p><p class="text-xs text-gray-400">${p.rarity}</p></div></div>
            <div><input type="checkbox" class="trade-pet-checkbox" data-pet-id="${p.id}"></div>
        </div>`).join('') || '<p class="text-gray-500">У вас нет питомцев</p>';

        document.getElementById('trade-my-paws').value = '';
        document.getElementById('trade-their-list').innerHTML = '<p class="text-gray-400">Ожидание предложений...</p>';
        document.getElementById('trade-modal').style.display='flex';
    }

    async function sendMyOfferUpdate(){
        if(!window.gameState.activeTrade) return;
        const tradeRef = doc(db,"trades",window.gameState.activeTrade.tradeId);
        // collect selected checkboxes
        const checked = Array.from(document.querySelectorAll('.trade-pet-checkbox:checked')).map(i=>i.getAttribute('data-pet-id'));
        const pawsVal = parseFloat(document.getElementById('trade-my-paws').value) || 0;
        // build pet objects for offer (id + snapshot of pet to allow display)
        const pets = window.gameState.inventory.filter(p=>checked.includes(p.id)).map(p=>({ ...p })); // shallow copy
        try{
            if(window.gameState.activeTrade.amInitiator){
                await updateDoc(tradeRef, { initiatorOffer: { pets, paws: Number(pawsVal) }, initiatorReady: false });
            } else {
                await updateDoc(tradeRef, { responderOffer: { pets, paws: Number(pawsVal) }, responderReady: false });
            }
            showToast('Предложение обновлено.');
        } catch(e){ console.error("sendMyOfferUpdate err",e); showToast('Не удалось обновить предложение.'); }
    }

    function updateTradeUIFromData(data){
        // show both offers in UI
        const myIsInitiator = window.gameState.activeTrade.amInitiator;
        const theirOffer = myIsInitiator ? data.responderOffer : data.initiatorOffer;
        const myOffer = myIsInitiator ? data.initiatorOffer : data.responderOffer;
        // render their offer
        const theirList = document.getElementById('trade-their-list');
        if(theirOffer && (theirOffer.pets && theirOffer.pets.length>0 || theirOffer.paws>0)){
            const petsHtml = (theirOffer.pets||[]).map(p=>`<div class="p-2 bg-gray-900 rounded-lg flex items-center mb-2">${getIconHtml(p,'w-8 h-8','mr-3')}<div><p class="text-sm ${p.color}">${p.name}</p><p class="text-xs text-gray-400">${p.rarity}</p></div></div>`).join('');
            const pawsHtml = theirOffer.paws ? `<p class="text-sm text-yellow-400 font-bold mt-2">+ ${theirOffer.paws} Лапок</p>` : '';
            theirList.innerHTML = `<div>${petsHtml}${pawsHtml}</div>`;
        } else {
            theirList.innerHTML = '<p class="text-gray-400">Пока пусто</p>';
        }
        // update ready indicators
        document.getElementById('trade-my-ready-indicator').textContent = (myIsInitiator ? data.initiatorReady : data.responderReady) ? 'Готов' : 'Не готов';
        document.getElementById('trade-their-ready-indicator').textContent = (myIsInitiator ? data.responderReady : data.initiatorReady) ? 'Готов' : 'Не готов';
    }

    async function setReadyStatus(agree){
        if(!window.gameState.activeTrade) return;
        const tradeRef = doc(db,"trades",window.gameState.activeTrade.tradeId);
        try{
            if(window.gameState.activeTrade.amInitiator){
                await updateDoc(tradeRef, { initiatorReady: Boolean(agree) });
            } else {
                await updateDoc(tradeRef, { responderReady: Boolean(agree) });
            }
            showToast(agree ? 'Ожидаем подтверждения соперника...' : 'Вы сняли готовность.');
            // check if both ready -> execute trade
            const snap = await getDoc(tradeRef);
            const d = snap.data();
            if(d.initiatorReady && d.responderReady){
                // execute swap (basic): transfer pet objects and paws accordingly
                await executeTrade(d, tradeRef);
            }
        } catch(e){ console.error("setReadyStatus err",e); showToast('Ошибка установки готовности.'); }
    }

    async function executeTrade(tradeData, tradeRef){
        // caution: this is a simplified atomic flow using batch writes where possible
        try {
            const initiator = tradeData.initiator;
            const responder = tradeData.responder;
            const initOffer = tradeData.initiatorOffer || { pets:[], paws:0 };
            const respOffer = tradeData.responderOffer || { pets:[], paws:0 };

            // load both player docs to ensure latest
            const initRef = doc(db,"players",initiator);
            const respRef = doc(db,"players",responder);
            const initSnap = await getDoc(initRef);
            const respSnap = await getDoc(respRef);
            const initData = initSnap.exists()? initSnap.data() : { inventory: [], paws: 0 };
            const respData = respSnap.exists()? respSnap.data() : { inventory: [], paws: 0 };

            // Remove pets by id from their owners and add other's pets
            // Identify pet ids in offers (offers store full pet object but include id)
            const initPetIds = (initOffer.pets||[]).map(p=>p.id);
            const respPetIds = (respOffer.pets||[]).map(p=>p.id);

            // Filter out offered pets from owner's inventory
            const newInitInv = (initData.inventory || []).filter(p => !initPetIds.includes(p.id)).concat((respOffer.pets || []).map(p=>({ ...p, id: crypto.randomUUID(), date: new Date().toISOString() })));
            const newRespInv = (respData.inventory || []).filter(p => !respPetIds.includes(p.id)).concat((initOffer.pets || []).map(p=>({ ...p, id: crypto.randomUUID(), date: new Date().toISOString() })));

            const newInitPaws = (Number(initData.paws) || 0) - Number(initOffer.paws || 0) + Number(respOffer.paws || 0);
            const newRespPaws = (Number(respData.paws) || 0) - Number(respOffer.paws || 0) + Number(initOffer.paws || 0);

            // batch update both players and trade doc
            const batch = writeBatch(db);
            batch.set(initRef, { inventory: newInitInv, paws: newInitPaws, lastSeen: serverTimestamp() }, { merge: true });
            batch.set(respRef, { inventory: newRespInv, paws: newRespPaws, lastSeen: serverTimestamp() }, { merge: true });
            batch.update(tradeRef, { status: 'completed', completedAt: serverTimestamp() });
            await batch.commit();

            // locally update saved state if current user involved
            if(currentUserId === initiator){
                window.gameState.inventory = newInitInv;
                window.gameState.paws = newInitPaws;
            } else if(currentUserId === responder){
                window.gameState.inventory = newRespInv;
                window.gameState.paws = newRespPaws;
            }
            await saveGameState();
            showToast('Обмен успешно выполнен!');
        } catch(e){ console.error("executeTrade err",e); showToast('Ошибка выполнения обмена.'); try{ await updateDoc(tradeRef,{ status:'cancelled' }); }catch(_){} }
    }

    async function cancelTrade(){
        if(!window.gameState.activeTrade) return;
        const tradeRef = doc(db,"trades",window.gameState.activeTrade.tradeId);
        try{
            await updateDoc(tradeRef, { status: 'cancelled' });
            if(window.currentTradeUnsub){ window.currentTradeUnsub(); window.currentTradeUnsub=null; }
            document.getElementById('trade-modal').style.display='none';
        } catch(e){ console.error("cancelTrade err",e); showToast('Не удалось отменить обмен.'); }
    }

    // ------------------- Case spinning simplified -------------------
    window.startCaseSpin = async function(){
        playMusic();
        const caseData = CASES[currentCaseId];
        if(!caseData) return showToast("Ошибка: Данные кейса не найдены.");
        if(!window.gameState.isDbReady) return showToast("Подождите, игра еще загружается...");
        if(window.gameState.paws < caseData.cost) return showToast(`Не хватает ${caseData.cost.toFixed(2)} Лапок!`);
        window.gameState.paws -= caseData.cost;
        const winningItem = getWeightedRandomItem(currentCaseId);
        const newItem = { ...winningItem, date: new Date().toISOString(), id: crypto.randomUUID() };
        window.gameState.inventory.push(newItem);
        if(!window.gameState.foundPets.includes(newItem.name)) window.gameState.foundPets.push(newItem.name);
        await saveGameState();
        updatePawsDisplay();
        renderInventory();
        showToast(`✅ ${newItem.name} добавлен в Инвентарь!`);
    }

    // ------------------- Passive loop & visibility -------------------
    function managePassiveLoop(){
        if(!window.gameState.isDbReady || document.hidden){
            if(passiveIntervalId) { clearInterval(passiveIntervalId); passiveIntervalId=null; }
            return;
        }
        if(!passiveIntervalId){
            passiveIntervalId = setInterval(()=>{ if(window.gameState.passiveRate>0){ window.gameState.paws += window.gameState.passiveRate; updatePawsDisplay(); saveGameState(); } }, PASSIVE_TICK_RATE);
        }
    }
    function handleVisibilityChange(){ managePassiveLoop(); if(document.visibilityState==='visible') requestWakeLock(); }

    // ------------------- Click handling -------------------
    function performPawsClick(){
        if(!window.gameState.isDbReady) return;
        window.gameState.paws += calculateClickValue();
        updatePawsDisplay();
        saveGameState();
        const clickButton = document.getElementById('click-button');
        clickButton.classList.add('scale-95');
        setTimeout(()=>clickButton.classList.remove('scale-95'),100);
        playMusic();
    }
    function setupClickListener(){
        const clickButton = document.getElementById('click-button');
        clickButton.addEventListener('touchstart', e=>{ e.preventDefault(); performPawsClick(); if(e.touches.length>=2) performPawsClick(); }, { passive:false });
        clickButton.addEventListener('click', ()=>{ performPawsClick(); });
    }

    // ------------------- Navigation -------------------
    window.setupNavigation = function(){
        const navItems = document.querySelectorAll('.nav-item');
        const sections = {
            'nav-home': document.getElementById('home-section'),
            'nav-inventory': document.getElementById('inventory-section'),
            'nav-cases': document.getElementById('cases-section'),
            'nav-settings': document.getElementById('settings-section'),
            'case-details': document.getElementById('case-details-section'),
        };
        function showSection(sectionId){
            Object.values(sections).forEach(s=>s.style.display='none');
            if(sections[sectionId]) sections[sectionId].style.display = (sectionId==='nav-home' || sectionId==='case-details') ? 'flex' : 'block';
            navItems.forEach(n=>n.classList.remove('active'));
            document.getElementById(sectionId.startsWith('nav-') ? sectionId : 'nav-cases')?.classList.add('active');
            if(sectionId==='nav-inventory') renderInventory();
        }
        navItems.forEach(item=>{
            item.addEventListener('touchstart', e=>{ e.preventDefault(); e.stopPropagation(); playNavClickSound(); showSection(item.id); });
            item.addEventListener('click', ()=>{ playNavClickSound(); showSection(item.id); });
        });
        window.closeCaseDetails = function(){ playNavClickSound(); showSection('nav-cases'); }
        return { showSection };
    }

    // ------------------- Updates panel content -------------------
    function setupUpdatesContent(){
        document.getElementById('updates-title-version').textContent = `(v${CURRENT_UPDATE_VERSION})`;
        // include a highlighted big update about trading
        const list = document.getElementById('updates-list');
        list.innerHTML = `
            <div class="p-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl mb-4 text-black shadow-lg">
                <h3 class="text-xl font-extrabold">МАССШТАБНОЕ ОБНОВЛЕНИЕ: Система обмена питомцами</h3>
                <p class="mt-2 text-sm">Добавлена полноценная система обмена между игроками: просматривайте игроков онлайн, инспектируйте их инвентарь и предлагайте обмены питомцами и Лапками. Интерфейс адаптирован для мобильных устройств.</p>
            </div>
            <div class="text-white">
                <p class="font-bold">Другие изменения:</p>
                <ul class="list-disc list-inside text-sm mt-2">
                    <li>Оптимизация интерфейса инвентаря под телефоны.</li>
                    <li>Кнопка "Авто-выбор" заменяет "Одеть лучших".</li>
                    <li>Мелкие багфиксы и оптимизация производительности.</li>
                </ul>
            </div>
        `;
    }

    // ------------------- Init Game -------------------
    async function initGame(){
        updateAppState(false);
        // ensure user id
        let uid = localStorage.getItem('petFarmUserId');
        if(!uid){ uid = crypto.randomUUID(); localStorage.setItem('petFarmUserId', uid); }
        currentUserId = uid;
        document.getElementById('user-id-display').textContent = `ID: ${currentUserId.substring(0,8)}...`;
        document.getElementById('user-id-display').title = `Ваш ID: ${currentUserId}`;

        await loadGameState();
        migrateInventory();
        window.gameState.isDbReady = true;

        // sync with Firestore cloud if exists
        try{
            await ensurePlayerDoc();
            const playerRef = doc(db,"players", currentUserId);
            const snap = await getDoc(playerRef);
            if(snap.exists()){
                const cloud = snap.data();
                // basic merge logic: if local inventory empty but cloud has data, restore from cloud
                if((!window.gameState.inventory || window.gameState.inventory.length===0) && cloud.inventory && cloud.inventory.length>0){
                    window.gameState.inventory = cloud.inventory;
                    window.gameState.paws = cloud.paws || window.gameState.paws;
                    showToast("Прогресс восстановлен из облака!");
                }
            }
            await saveGameState();
        } catch(e){ console.error("init sync err",e); }

        updatePawsDisplay();
        updateAppState(true);
        document.addEventListener('visibilitychange', handleVisibilityChange);
        managePassiveLoop();
        window.setupNavigation();
        setupUpdatesContent();
        setupClickListener();
        setupResetConfirmationListener();
        requestWakeLock();
        window.checkAndShowUpdatesScreen = function(force=false){
            const modal = document.getElementById('updates-modal');
            if(force) { modal.style.display='flex'; return; }
            if(localStorage.getItem('lastShownUpdateVersion') !== CURRENT_UPDATE_VERSION) modal.style.display='flex';
        };
        window.checkAndShowUpdatesScreen();

        // presence ping
        if(presenceIntervalId) clearInterval(presenceIntervalId);
        presenceIntervalId = setInterval(()=>{
            if(currentUserId){
                updateDoc(doc(db,"players",currentUserId), { lastSeen: serverTimestamp() }).catch(()=>{});
            }
        }, 60*1000);
    }

    // ------------------- Small listeners -------------------
    function setupResetConfirmationListener(){
        const input = document.getElementById('reset-confirm-input');
        const confirmBtn = document.getElementById('reset-confirm-button');
        const requiredText = 'удалить данные';
        input.addEventListener('input', ()=>{
            if(input.value.trim() === requiredText){ confirmBtn.disabled = false; confirmBtn.classList.remove('bg-red-800','text-gray-500','cursor-not-allowed'); confirmBtn.classList.add('bg-red-600','hover:bg-red-500'); }
            else { confirmBtn.disabled = true; confirmBtn.classList.add('bg-red-800','text-gray-500','cursor-not-allowed'); confirmBtn.classList.remove('bg-red-600','hover:bg-red-500'); }
        });
    }

    // ------------------- Wake Lock -------------------
    let wakeLock = null;
    async function requestWakeLock(){
        if('wakeLock' in navigator){
            try{ wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', ()=>{ wakeLock=null; }); }catch(e){ console.warn('WakeLock not available', e); }
        }
    }

    window.onload = initGame;
    </script>

    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    body{ font-family:'Inter',sans-serif;background:#0f1724;color:#e6eef8;margin:0; }
    .content-area{ padding:20px;padding-top:80px;padding-bottom:100px; max-width:960px;margin:0 auto; }
    .bottom-nav{ position:fixed; bottom:0; left:0; width:100%; display:flex; background:#1f2937; border-top:1px solid #334155; height:72px; align-items:center; z-index:60; }
    .nav-item{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#94a3b8; font-size:0.75rem; cursor:pointer; }
    .nav-item.active{ color:#60a5fa; }
    .case-card{ background:#111827; padding:16px; border-radius:12px; }
    /* modal styles */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; padding:20px; }
    .modal .panel { background:#0b1220; padding:18px; border-radius:12px; max-height:90vh; overflow:auto; width:100%; max-width:720px; color:#e2e8f0; }
    .inventory-item-secret { animation: 3s infinite alternate rainbow-border-left; }
    @keyframes rainbow-border-left { 0%{ border-left-color:#facc15;} 25%{border-left-color:#ef4444;}50%{border-left-color:#3b82f6;}75%{border-left-color:#4ade80;}100%{border-left-color:#facc15;} }
    @media (max-width:640px){ .content-area{ padding:12px;padding-top:76px;padding-bottom:96px; } .case-card{ max-width:160px; } .bottom-nav{ height:72px; } }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <audio id="backgroundMusic" loop src="https://files.catbox.moe/b1gm68.mp3"></audio>

    <header class="fixed top-0 left-0 w-full bg-gray-800 p-3 shadow-lg z-50 flex justify-between items-center h-16">
        <div class="text-white text-xl font-black tracking-wider">Pet Farm</div>
        <div class="flex flex-col items-end">
            <p id="paws-display" class="text-lg font-extrabold text-orange-400">Лапки: 0.00</p>
            <p id="user-id-display" class="text-xs text-gray-400 mt-0 cursor-pointer" title="Ваш ID">ID: ...</p>
        </div>
    </header>

    <main class="content-area">
        <!-- HOME -->
        <section id="home-section" class="flex-col items-center justify-center space-y-6" style="display:flex;">
            <div class="text-center">
                <h1 class="text-3xl font-black">Кликай, чтобы заработать!</h1>
                <p id="click-message" class="text-sm text-gray-300 mt-2">Жми на кнопку (мышью или пальцем)</p>
                <p id="click-power-display" class="text-sm text-blue-300 font-bold mt-1">Сила клика: 0.09</p>
                <p id="passive-rate-display" class="text-sm text-green-300 font-bold mt-1">Авто: +0.00 / с</p>
                <p id="loading-message" class="text-sm text-red-400 mt-2" style="display:none;">Загрузка данных...</p>
            </div>
            <button id="click-button" class="w-48 h-48 rounded-full bg-orange-500 text-white text-3xl font-bold shadow-2xl hover:bg-orange-400">
                <i class="fas fa-paw"></i>
            </button>
        </section>

        <!-- INVENTORY -->
        <section id="inventory-section" style="display:none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Мой Инвентарь</h2>
                <div class="flex space-x-2">
                    <button onclick="window.showUpgradesModal()" class="px-3 py-2 bg-yellow-600 rounded-xl">Улучшения</button>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl mb-4 flex justify-between items-center border-l-4 border-blue-500">
                <p class="text-lg font-semibold">Активные Питомцы</p>
                <p id="active-pets-count" class="text-lg font-bold text-blue-400">Активных: 0 / 3</p>
            </div>

            <!-- new layout: two buttons left/right and orange players button below -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button onclick="window.showCollectionModal()" class="py-3 px-4 bg-blue-600 rounded-xl w-full text-white font-bold flex items-center justify-center"><i class="fas fa-book mr-2"></i> Коллекция</button>
                <button onclick="window.equipBestPets()" class="py-3 px-4 bg-purple-600 rounded-xl w-full text-white font-bold flex items-center justify-center"><i class="fas fa-bolt mr-2"></i> Авто-выбор</button>
            </div>
            <div class="mb-4">
                <button onclick="window.showPlayersModal()" class="py-3 px-4 bg-orange-500 rounded-xl w-full text-white font-bold flex items-center justify-center"><i class="fas fa-users mr-2"></i> Игроки</button>
            </div>

            <div id="inventory-container" class="space-y-3"></div>
            <div id="inventory-empty-state" class="flex flex-col items-center justify-center p-8 bg-gray-800 rounded-xl mt-4 border-2 border-dashed border-gray-700" style="display:flex;">
                <i class="fas fa-box-open text-5xl text-gray-600 mb-3"></i>
                <p class="text-lg font-semibold text-gray-400">Инвентарь пуст!</p>
                <p class="text-sm text-gray-500 mt-1">Открой кейсы, чтобы найти животных.</p>
            </div>
        </section>

        <!-- CASES -->
        <section id="cases-section" style="display:none;">
            <h2 class="text-2xl font-bold mb-4">Магазин Кейсов</h2>
            <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4">
                <div class="case-card p-4" onclick="window.showCaseDetails('farmer')">
                    <img src="https://files.catbox.moe/teasjx.png" class="w-24 h-24 object-cover mx-auto mb-3 rounded-lg border-4 border-green-400">
                    <p class="text-lg font-extrabold">Фермерский Кейс</p>
                    <p class="text-sm text-gray-400">Животные со всей фермы!</p>
                    <p class="text-md font-bold text-green-400 mt-2">100 Лапок</p>
                </div>
                <div class="case-card p-4" onclick="window.showCaseDetails('jungle')">
                    <img src="https://files.catbox.moe/adaf91.jpg" class="w-24 h-24 object-cover mx-auto mb-3 rounded-lg border-4 border-yellow-400">
                    <p class="text-lg font-extrabold">Джунглийский Кейс</p>
                    <p class="text-sm text-gray-400">Экзотические животные!</p>
                    <p class="text-md font-bold text-green-400 mt-2">2000 Лапок</p>
                </div>
            </div>
        </section>

        <!-- CASE DETAILS -->
        <section id="case-details-section" style="display:none;">
            <div class="bg-gray-800 p-4 rounded-xl">
                <button onclick="window.closeCaseDetails()" class="text-gray-300 mb-3"><i class="fas fa-arrow-left mr-2"></i> Вернуться</button>
                <h2 id="case-details-title" class="text-2xl font-black mb-3"></h2>
                <div class="bg-gray-900 p-2 rounded-xl mb-3">
                    <div id="case-preview-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>
                <button id="open-case-button" class="w-full py-3 rounded-xl text-white font-extrabold"></button>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="settings-section" style="display:none;">
            <h2 class="text-2xl font-bold mb-4">Настройки</h2>
            <div class="bg-gray-800 p-4 rounded-xl mb-3">
                <button onclick="window.checkAndShowUpdatesScreen(true)" class="w-full px-4 py-2 bg-blue-600 rounded-lg text-white">История Обновлений</button>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl">
                <button onclick="window.showResetConfirmation()" class="w-full px-4 py-2 bg-red-600 rounded-lg text-white">Сбросить Прогресс</button>
            </div>
        </section>
    </main>

    <!-- Bottom nav -->
    <nav class="bottom-nav">
        <div id="nav-home" class="nav-item active"><i class="fas fa-home"></i><span class="text-xs">Главная</span></div>
        <div id="nav-cases" class="nav-item"><i class="fas fa-box"></i><span class="text-xs">Кейсы</span></div>
        <div id="nav-inventory" class="nav-item"><i class="fas fa-boxes"></i><span class="text-xs">Инвентарь</span></div>
        <div id="nav-settings" class="nav-item"><i class="fas fa-cog"></i><span class="text-xs">Настройки</span></div>
    </nav>

    <!-- Notification Toast -->
    <div id="notification-modal" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 p-3 bg-gray-700 text-white rounded-lg shadow-lg z-50" style="display:none;">
        <p id="notification-text" class="text-sm font-semibold"></p>
    </div>

    <!-- Pet preview modal -->
    <div id="pet-preview-modal" class="modal">
        <div class="panel" id="pet-preview-content">
            <div class="text-center">
                <div id="win-icon-container" class="w-24 h-24 mx-auto mb-4 bg-gray-900 rounded-xl overflow-hidden"></div>
                <img id="pet-preview-image" src="" class="w-24 h-24 mx-auto mb-4 rounded-lg object-cover" />
                <h3 id="pet-preview-name" class="text-2xl font-extrabold mb-1">Имя</h3>
                <p id="pet-preview-rarity" class="text-sm mb-4">Раритет</p>
                <div id="pet-preview-buttons" class="flex gap-2"></div>
                <div class="mt-4">
                    <button onclick="window.closePetPreview()" class="px-4 py-2 bg-gray-600 rounded-lg">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Players modal -->
    <div id="players-modal" class="modal">
        <div class="panel">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold">Игроки онлайн</h3>
                <button onclick="window.closePlayersModal()" class="px-3 py-1 bg-gray-700 rounded-lg">Закрыть</button>
            </div>
            <div id="players-list-container" class="space-y-2"></div>
        </div>
    </div>

    <!-- Inspect player modal -->
    <div id="player-inspect-modal" class="modal">
        <div class="panel">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h3 id="player-inspect-name" class="text-lg font-bold">Игрок:</h3>
                    <p id="player-inspect-paws" class="text-sm text-gray-400">Лапок: 0.00</p>
                </div>
                <div><button onclick="window.closeInspectModal()" class="px-3 py-1 bg-gray-700 rounded-lg">Закрыть</button></div>
            </div>
            <div id="player-inspect-container" class="grid grid-cols-1 gap-2"></div>
        </div>
    </div>

    <!-- Trade modal -->
    <div id="trade-modal" class="modal">
        <div class="panel">
            <div class="flex justify-between items-center mb-3">
                <h3 id="trade-with-name" class="text-lg font-bold">Обмен с:</h3>
                <div><button onclick="cancelTrade()" class="px-3 py-1 bg-red-600 rounded-lg text-white">Отмена</button></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h4 class="font-bold mb-2">Ваше предложение</h4>
                    <div id="trade-my-pets" class="mb-2 max-h-48 overflow:auto"></div>
                    <input id="trade-my-paws" type="number" placeholder="Добавить Лапок" class="w-full p-2 rounded-lg bg-gray-800 mb-2" />
                    <div class="flex gap-2">
                        <button onclick="sendMyOfferUpdate()" class="flex-1 px-3 py-2 bg-blue-600 rounded-lg text-white">Обновить</button>
                        <button onclick="setReadyStatus(true)" class="flex-1 px-3 py-2 bg-green-600 rounded-lg text-white">Согласен</button>
                    </div>
                    <p class="mt-2 text-sm">Ваш статус: <span id="trade-my-ready-indicator">Не готов</span></p>
                </div>
                <div>
                    <h4 class="font-bold mb-2">Предложение собеседника</h4>
                    <div id="trade-their-list" class="mb-2 max-h-48 overflow:auto"></div>
                    <p class="mt-2 text-sm">Статус собеседника: <span id="trade-their-ready-indicator">Не готов</span></p>
                </div>
            </div>

            <div class="mt-4 text-right">
                <button onclick="cancelTrade()" class="px-4 py-2 bg-gray-600 rounded-lg">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Sell confirm modal -->
    <div id="sell-confirm-modal" class="modal">
        <div class="panel text-center">
            <h3 class="text-lg font-bold">Подтвердите продажу</h3>
            <p class="mt-2">Питомец: <b id="sell-pet-name"></b></p>
            <p class="mt-1 text-yellow-300">Цена: <b id="sell-pet-price"></b> Лапок</p>
            <div class="mt-4 flex gap-2 justify-center">
                <button onclick="performSell()" id="sell-confirm-button" class="px-4 py-2 bg-red-600 rounded-lg text-white">Продать</button>
                <button onclick="document.getElementById('sell-confirm-modal').style.display='none'" class="px-4 py-2 bg-gray-600 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Reset confirm modal -->
    <div id="reset-confirm-modal" class="modal">
        <div class="panel text-center">
            <h3 class="text-lg font-bold">Сброс прогресса</h3>
            <p class="text-sm text-gray-400">Введите <b>удалить данные</b> чтобы подтвердить</p>
            <input id="reset-confirm-input" class="w-full p-2 rounded-lg bg-gray-800 mt-3" placeholder="удалить данные" />
            <div class="mt-4 flex gap-2 justify-center">
                <button id="reset-confirm-button" onclick="performReset()" disabled class="px-4 py-2 bg-red-800 text-gray-500 rounded-lg">Подтвердить</button>
                <button onclick="closeResetConfirmation()" class="px-4 py-2 bg-gray-600 rounded-lg">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Updates modal -->
    <div id="updates-modal" class="modal">
        <div class="panel">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold">История обновлений <span id="updates-title-version" class="text-sm text-gray-400"></span></h3>
                <div><button onclick="document.getElementById('updates-modal').style.display='none'; localStorage.setItem('lastShownUpdateVersion', CURRENT_UPDATE_VERSION);" class="px-3 py-1 bg-gray-700 rounded-lg">Закрыть</button></div>
            </div>
            <div id="updates-list" class="space-y-3"></div>
        </div>
    </div>

</body>
</html>
