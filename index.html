<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>My Pet Game ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a2e0e9d79b.js" crossorigin="anonymous"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #0f0f0f, #1c1c1c);
      color: white;
      overflow-x: hidden;
      font-family: "Segoe UI", sans-serif;
      user-select: none;
    }
    button {
      transition: all 0.2s ease;
    }
    button:active {
      transform: scale(0.96);
    }
  </style>

  <!-- üîπ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { 
      getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, writeBatch, query, onSnapshot, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyARZvFpMMn5t8pg5gb2bWA6OrZC1L8DBSA",
      authDomain: "my-pet-c8684.firebaseapp.com",
      projectId: "my-pet-c8684",
      storageBucket: "my-pet-c8684.firebasestorage.app",
      messagingSenderId: "102742166711",
      appId: "1:102742166711:web:aa6b251fd6d6c993c71132"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è playerId
    let playerId = localStorage.getItem("playerId");
    if (!playerId) {
      playerId = "player_" + Math.random().toString(36).substring(2, 10);
      localStorage.setItem("playerId", playerId);
    }
    window.playerId = playerId;

    console.log("–í–∞—à ID:", playerId);

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –±–∞–∑–µ
    async function registerPlayer() {
      try {
        await setDoc(doc(db, "players", playerId), {
          lastSeen: serverTimestamp(),
          paws: 0,
          inventory: [],
          inTrade: false
        }, { merge: true });
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", e);
      }
    }
    registerPlayer();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä–æ–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(async () => {
      try {
        await updateDoc(doc(db, "players", playerId), {
          lastSeen: serverTimestamp()
        });
      } catch (e) {}
    }, 5000);
  </script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md text-center">
    <h1 class="text-3xl font-bold text-orange-400 mb-4">üêæ My Pet Game</h1>
    <p class="text-gray-300 mb-4">ID –∏–≥—Ä–æ–∫–∞: <span class="font-mono text-yellow-400" id="player-id"></span></p>

    <script>
      document.getElementById("player-id").textContent = localStorage.getItem("playerId") || "???";
    </script>
    <!-- üîπ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="inventory-controls" class="flex flex-col items-center space-y-2 mt-2">
      <div class="flex space-x-2 w-full">
        <button onclick="window.showCollectionModal()" 
          class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-xl w-1/2 transition">
          –ö–æ–ª–ª–µ–∫—Ü–∏—è
        </button>
        <button onclick="window.equipBest()" 
          class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-xl w-1/2 transition">
          –ê–≤—Ç–æ-–≤—ã–±–æ—Ä
        </button>
      </div>
      <button onclick="window.showPlayersModal()" 
        class="bg-orange-500 hover:bg-orange-400 text-white font-bold py-2 rounded-xl w-full mt-2 transition">
        –ò–≥—Ä–æ–∫–∏
      </button>
    </div>

    <!-- üîπ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ -->
    <div id="players-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-40">
      <div class="bg-gray-800 rounded-xl p-4 w-11/12 max-w-lg">
        <h3 class="text-white font-bold mb-2">–ò–≥—Ä–æ–∫–∏ –æ–Ω–ª–∞–π–Ω</h3>
        <div id="players-list-container" class="max-h-64 overflow-auto mb-3"></div>
        <button onclick="window.closePlayersModal()" class="bg-gray-600 text-white py-2 px-3 rounded-xl w-full">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>

    <!-- üîπ –ú–æ–¥–∞–ª –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–≥—Ä–æ–∫–∞ -->
    <div id="player-inspect-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
      <div class="bg-gray-900 rounded-xl p-4 w-11/12 max-w-md text-left">
        <h3 id="player-inspect-name" class="text-white font-bold mb-1">–ò–≥—Ä–æ–∫:</h3>
        <p id="player-inspect-paws" class="text-yellow-400 mb-2">–õ–∞–ø–∫–∏: 0</p>
        <div id="player-inspect-container" class="max-h-56 overflow-auto"></div>
        <button onclick="document.getElementById('player-inspect-modal').style.display='none';" 
          class="bg-gray-600 text-white py-2 px-3 rounded-xl mt-3 w-full">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <!-- üîπ –ú–æ–¥–∞–ª –æ–±–º–µ–Ω–∞ -->
    <div id="trade-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
      <div class="bg-gray-800 rounded-xl p-4 w-11/12 max-w-2xl">
        <h3 id="trade-with-name" class="text-white font-bold mb-2">–û–±–º–µ–Ω</h3>
        <div class="panel">
          <div class="mb-3">
            <h4 class="text-white font-semibold">
              –í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ <span id="trade-my-ready-indicator" class="text-sm text-gray-300">–ù–µ –≥–æ—Ç–æ–≤</span>
            </h4>
            <div id="trade-my-pets" class="mb-2"></div>
            <input id="trade-my-paws" type="number" placeholder="–î–û–ü–õ–ê–¢–ê (–õ–∞–ø–∫–∏)" 
              class="w-full p-2 rounded-xl bg-gray-700 text-white mb-2"/>
            <button onclick="sendMyOfferUpdate()" 
              class="bg-blue-600 text-white py-2 px-3 rounded-xl w-full mb-2">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
            <button onclick="setReadyStatus(true)" 
              class="bg-green-600 text-white py-2 px-3 rounded-xl w-full mb-1">–°–æ–≥–ª–∞—Å–µ–Ω</button>
            <button onclick="setReadyStatus(false)" 
              class="bg-gray-600 text-white py-2 px-3 rounded-xl w-full mb-2">–û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ</button>
          </div>
          <hr class="my-2 border-gray-600"/>
          <div>
            <h4 class="text-white font-semibold">
              –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ <span id="trade-their-ready-indicator" class="text-sm text-gray-300">–ù–µ –≥–æ—Ç–æ–≤</span>
            </h4>
            <div id="trade-their-list" class="mb-2"></div>
            <button onclick="cancelTrade()" 
              class="bg-red-600 text-white py-2 px-3 rounded-xl w-full">–û—Ç–º–µ–Ω–∏—Ç—å –æ–±–º–µ–Ω</button>
          </div>
        </div>
      </div>
    </div>

    <!-- üîπ –û–∫–Ω–æ –ù–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏—è -->
    <div id="newsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-5 text-center">
        <h2 class="text-2xl font-bold text-orange-500 mb-3">üî• –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî –°–∏—Å—Ç–µ–º–∞ –æ–±–º–µ–Ω–∞ –ø–∏—Ç–æ–º—Ü–∞–º–∏!</h2>
        <p class="text-gray-700 text-base mb-4">
          –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –ø–∏—Ç–æ–º—Ü–∞–º–∏ –∏ –¥–µ–Ω—å–≥–∞–º–∏ —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏ –æ–Ω–ª–∞–π–Ω.
        </p>
        <button onclick="closeNewsModal()" 
          class="bg-green-500 hover:bg-green-400 text-white font-bold py-2 px-4 rounded-xl mt-3 w-full transition">
          –ü–æ–Ω—è–ª!
        </button>
      </div>
    </div>

    <script>
      function showNewsModalOnce() {
        const seen = localStorage.getItem("tradeUpdateSeen");
        if (!seen) document.getElementById("newsModal").classList.remove("hidden");
      }
      function closeNewsModal() {
        localStorage.setItem("tradeUpdateSeen", true);
        document.getElementById("newsModal").classList.add("hidden");
      }
      window.addEventListener("load", showNewsModalOnce);
    </script>
<!-- ========== –ß–ê–°–¢–¨ 3: –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ‚Äî players, trades, UI ========== -->
<script type="module">
  // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Firestore (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–º–ø–æ—Ä—Ç ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
  import {
    collection, query, getDocs, doc, getDoc, setDoc, updateDoc,
    onSnapshot, writeBatch, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // –£–¥–æ–±–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
  const DB = window.db;
  const PLAYERS_COLL = collection(DB, "players");
  const TRADES_COLL_NAME = "trades";

  // -------------------- üîπ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI --------------------
  function safePlayClick() { if (typeof playNavClickSound === 'function') playNavClickSound(); }
  function safeToast(msg) { if (typeof showToast === 'function') showToast(msg); else console.log("TOAST:", msg); }
  function getIconHtml(pet, sizeClass = 'w-8 h-8', extra = '') {
    const src = pet.icon || ('https://placehold.co/60x60/374151/fff?text=?');
    const color = pet.color || '';
    return `<img src="${src}" class="${sizeClass} object-cover rounded-md ${extra}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/374151/fff?text=?'">`;
  }

  // -------------------- üîπ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è --------------------
  window.gameState = window.gameState || {};
  window.gameState.inventory = window.gameState.inventory || []; // –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –ø–æ–∑–∂–µ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—Å—è
  window.gameState.paws = window.gameState.paws || 0;
  let playersPollInterval = null;
  window.currentTradeUnsub = null;

  // -------------------- üîπ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ (poll 5s) --------------------
  async function fetchPlayersAndRender() {
    const container = document.getElementById('players-list-container');
    if (!container) return;
    container.innerHTML = '<p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    try {
      const q = query(PLAYERS_COLL);
      const snap = await getDocs(q);
      const now = Date.now();
      let html = '';
      snap.forEach(s => {
        const d = s.data();
        const id = s.id;
        const lastSeen = d.lastSeen ? (d.lastSeen.toDate ? d.lastSeen.toDate().getTime() : new Date(d.lastSeen).getTime()) : 0;
        const online = (now - lastSeen) <= 60 * 1000;
        const inTrade = !!d.inTrade;
        const statusText = online ? (inTrade ? '‚öôÔ∏è –í –æ–±–º–µ–Ω–µ' : 'üü¢ –û–Ω–ª–∞–π–Ω') : '‚ö´ –û—Ñ—Ñ–ª–∞–π–Ω';
        const clickable = online && !inTrade && id !== window.playerId;
        const opacity = online ? 'opacity-100' : 'opacity-60';
        const disabledAttr = clickable ? '' : 'disabled';
        html += `<div class="bg-gray-700 p-3 rounded-xl flex items-center justify-between mb-2 ${opacity}">
          <div>
            <p class="font-bold text-white truncate w-48" title="${id}">–ò–≥—Ä–æ–∫: ${id.substring(0,8)}...</p>
            <p class="text-sm ${online ? 'text-green-400' : 'text-gray-400'}">${statusText}</p>
          </div>
          <div class="flex items-center space-x-2">
            <button ${disabledAttr} onclick="window.inspectPlayer('${id}')" class="px-3 py-2 rounded-lg text-sm font-bold ${clickable ? 'bg-blue-600 hover:bg-blue-500' : 'bg-gray-600 cursor-not-allowed'}"><i class="fas fa-eye"></i></button>
            <button ${disabledAttr} onclick="window.initiateTrade('${id}')" class="px-3 py-2 rounded-lg text-sm font-bold ${clickable ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-gray-600 cursor-not-allowed'}"><i class="fas fa-exchange-alt mr-1"></i>–û–±–º–µ–Ω</button>
          </div>
        </div>`;
      });
      container.innerHTML = html || '<p class="text-gray-400 text-center">–°–µ–π—á–∞—Å –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–µ—Ç–∏.</p>';
    } catch (e) {
      console.error("fetchPlayersAndRender err", e);
      container.innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤.</p>';
    }
  }

  function startPlayersPolling() {
    if (playersPollInterval) clearInterval(playersPollInterval);
    fetchPlayersAndRender().catch(()=>{});
    playersPollInterval = setInterval(()=>{ fetchPlayersAndRender().catch(()=>{}); }, 5000);
  }
  function stopPlayersPolling() {
    if (playersPollInterval) { clearInterval(playersPollInterval); playersPollInterval = null; }
  }

  window.showPlayersModal = function() {
    safePlayClick();
    const m = document.getElementById('players-modal');
    if (m) {
      m.style.display = 'flex';
      startPlayersPolling();
    }
  };
  window.closePlayersModal = function() {
    safePlayClick();
    const m = document.getElementById('players-modal');
    if (m) { m.style.display = 'none'; stopPlayersPolling(); }
  };

  // -------------------- üîπ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏–≥—Ä–æ–∫–∞ --------------------
  window.inspectPlayer = async function(otherId) {
    safePlayClick();
    const modal = document.getElementById('player-inspect-modal');
    const container = document.getElementById('player-inspect-container');
    if (!modal || !container) return;
    document.getElementById('player-inspect-name').textContent = `–ò–≥—Ä–æ–∫: ${otherId.substring(0,8)}...`;
    container.innerHTML = '<p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    modal.style.display = 'flex';
    try {
      const snap = await getDoc(doc(DB, "players", otherId));
      if (!snap.exists()) {
        container.innerHTML = '<p class="text-gray-400">–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</p>';
        return;
      }
      const pdata = snap.data();
      document.getElementById('player-inspect-paws').textContent = `–õ–∞–ø–∫–∏: ${pdata.paws ? Number(pdata.paws).toFixed(2) : '0.00'}`;
      const inv = pdata.inventory || [];
      if (inv.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
        return;
      }
      container.innerHTML = inv.map(pet => {
        const border = pet.border ? pet.border.replace('border-','border-l-') : 'border-l-4 border-gray-400';
        const colorClass = pet.color || 'text-gray-400';
        const icon = pet.icon || 'https://placehold.co/60x60/374151/fff?text=?';
        return `<div class="p-2 bg-gray-900 rounded-lg flex items-center border-l-4 ${border} mb-2">
          ${getIconHtml(pet,'w-10 h-10 mr-3')}
          <div><p class="font-bold text-sm ${colorClass}">${pet.name}</p><p class="text-xs text-gray-400">${pet.rarity||''}</p></div>
        </div>`;
      }).join('');
    } catch (e) {
      console.error("inspectPlayer err", e);
      container.innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.</p>';
    }
  };

  // -------------------- üîπ –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –æ–±–º–µ–Ω–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ trade) --------------------
  window.initiateTrade = async function(otherId) {
    safePlayClick();
    if (!otherId) return;
    if (otherId === window.playerId) return safeToast("–ù–µ–ª—å–∑—è –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π.");
    try {
      const otherSnap = await getDoc(doc(DB, "players", otherId));
      const meSnap = await getDoc(doc(DB, "players", window.playerId));
      const otherData = otherSnap.exists() ? otherSnap.data() : {};
      const myData = meSnap.exists() ? meSnap.data() : {};
      if (otherData.inTrade) return safeToast("–°–µ–π—á–∞—Å —ç—Ç–æ—Ç –∏–≥—Ä–æ–∫ –∑–∞–Ω—è—Ç –≤ –¥—Ä—É–≥–æ–º –æ–±–º–µ–Ω–µ.");
      if (myData.inTrade) return safeToast("–°–µ–π—á–∞—Å –≤—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –¥—Ä—É–≥–æ–º –æ–±–º–µ–Ω–µ.");

      const tradeId = crypto.randomUUID();
      const tradeRef = doc(DB, TRADES_COLL_NAME, tradeId);
      const payload = {
        createdAt: serverTimestamp(),
        status: "pending",
        playerA: window.playerId,
        playerB: otherId,
        aOffer: { pets: [], paws: 0 },
        bOffer: { pets: [], paws: 0 },
        aReady: false,
        bReady: false
      };
      await setDoc(tradeRef, payload);
      // –ø–æ–º–µ—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ inTrade:true
      await updateDoc(doc(DB, "players", window.playerId), { inTrade: true });
      await updateDoc(doc(DB, "players", otherId), { inTrade: true });

      openTradeModal(tradeId, true, otherId);
      listenToTrade(tradeId);
    } catch (e) {
      console.error("initiateTrade err", e);
      safeToast("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –æ–±–º–µ–Ω.");
    }
  };

  // -------------------- üîπ –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –æ–±–º–µ–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω–æ) --------------------
  function openTradeModal(tradeId, amInitiator, otherId) {
    safePlayClick();
    window.gameState.activeTrade = { tradeId, amInitiator, withUser: otherId };
    const title = document.getElementById('trade-with-name');
    if (title) title.textContent = `–û–±–º–µ–Ω —Å: ${otherId.substring(0,8)}...`;
    const myPetsContainer = document.getElementById('trade-my-pets');
    if (myPetsContainer) {
      myPetsContainer.innerHTML = (window.gameState.inventory || []).map(p => {
        return `<div class="p-2 bg-gray-800 rounded-lg flex items-center justify-between mb-2">
          <div class="flex items-center">${getIconHtml(p,'w-10 h-10 mr-3')}<div><p class="font-bold text-sm ${p.color||''}">${p.name}</p><p class="text-xs text-gray-400">${p.rarity||''}</p></div></div>
          <div><input type="checkbox" class="trade-pet-checkbox" data-pet-id="${p.id}"></div>
        </div>`;
      }).join('') || '<p class="text-gray-500">–£ –≤–∞—Å –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤</p>';
    }
    const input = document.getElementById('trade-my-paws'); if (input) input.value = '';
    const theirList = document.getElementById('trade-their-list'); if (theirList) theirList.innerHTML = '<p class="text-gray-400">–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</p>';
    const modal = document.getElementById('trade-modal'); if (modal) modal.style.display = 'flex';
    const mri = document.getElementById('trade-my-ready-indicator'); if (mri) mri.textContent = '–ù–µ –≥–æ—Ç–æ–≤';
    const tri = document.getElementById('trade-their-ready-indicator'); if (tri) tri.textContent = '–ù–µ –≥–æ—Ç–æ–≤';
    // remove any previous note
    const note = document.getElementById('trade-wait-note'); if (note) note.remove();
  }

  // -------------------- üîπ –°–ª—É—à–∞–µ–º trade –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º UI --------------------
  function listenToTrade(tradeId) {
    const tradeRef = doc(DB, TRADES_COLL_NAME, tradeId);
    if (window.currentTradeUnsub) { window.currentTradeUnsub(); window.currentTradeUnsub = null; }
    window.currentTradeUnsub = onSnapshot(tradeRef, async snap => {
      if (!snap.exists()) return;
      const d = snap.data();
      // –µ—Å–ª–∏ cancelled/completed ‚Äî —á–∏—Å—Ç–∏–º
      if (d.status === 'cancelled' || d.status === 'completed') {
        try {
          await updateDoc(doc(DB, "players", d.playerA), { inTrade: false });
          await updateDoc(doc(DB, "players", d.playerB), { inTrade: false });
        } catch(e){}
        safeToast(d.status === 'completed' ? '–û–±–º–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω' : '–û–±–º–µ–Ω –æ—Ç–º–µ–Ω—ë–Ω');
        const modal = document.getElementById('trade-modal'); if (modal) modal.style.display = 'none';
        if (window.currentTradeUnsub) { window.currentTradeUnsub(); window.currentTradeUnsub = null; }
        // –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
        try {
          const meSnap = await getDoc(doc(DB,"players",window.playerId));
          if (meSnap.exists()) {
            const me = meSnap.data();
            window.gameState.inventory = me.inventory || [];
            window.gameState.paws = me.paws || 0;
            if (typeof savePaws === 'function') savePaws(window.gameState.paws);
            if (typeof renderInventory === 'function') renderInventory();
            if (typeof updatePawsDisplay === 'function') updatePawsDisplay();
          }
        } catch(e){}
        return;
      }

      // –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      const myIsA = (d.playerA === window.playerId);
      const myReady = myIsA ? d.aReady : d.bReady;
      const theirReady = myIsA ? d.bReady : d.aReady;
      const myIndicator = document.getElementById('trade-my-ready-indicator');
      const theirIndicator = document.getElementById('trade-their-ready-indicator');
      if (myIndicator) myIndicator.textContent = myReady ? '–ì–æ—Ç–æ–≤' : '–ù–µ –≥–æ—Ç–æ–≤';
      if (theirIndicator) theirIndicator.textContent = theirReady ? '–ì–æ—Ç–æ–≤' : '–ù–µ –≥–æ—Ç–æ–≤';

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
      const theirOffer = myIsA ? d.bOffer : d.aOffer;
      const theirListEl = document.getElementById('trade-their-list');
      if (theirListEl) {
        if (theirOffer && ((theirOffer.pets && theirOffer.pets.length>0) || (theirOffer.paws && Number(theirOffer.paws)>0))) {
          const petsHtml = (theirOffer.pets||[]).map(p => `<div class="p-2 bg-gray-900 rounded-lg flex items-center mb-2">${getIconHtml(p,'w-8 h-8 mr-3')}<div><p class="text-sm ${p.color||''}">${p.name}</p><p class="text-xs text-gray-400">${p.rarity||''}</p></div></div>`).join('');
          const pawsHtml = theirOffer.paws ? `<p class="text-sm text-yellow-400 font-bold mt-2">+ ${Number(theirOffer.paws).toFixed(2)} –õ–∞–ø–æ–∫</p>` : '';
          theirListEl.innerHTML = `${petsHtml}${pawsHtml}`;
        } else {
          theirListEl.innerHTML = '<p class="text-gray-400">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</p>';
        }
      }

      // –µ—Å–ª–∏ –æ–±–∞ –≥–æ—Ç–æ–≤—ã ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–±–º–µ–Ω (atomic via batch)
      const bothReady = !!(d.aReady && d.bReady);
      if (bothReady) {
        try {
          const tradeRefLocal = doc(DB, TRADES_COLL_NAME, tradeId);
          const snapLatest = await getDoc(tradeRefLocal);
          const latest = snapLatest.data();
          if (latest.status !== 'executing' && latest.status !== 'completed') {
            await updateDoc(tradeRefLocal, { status: 'executing' });

            const aRef = doc(DB, "players", d.playerA);
            const bRef = doc(DB, "players", d.playerB);
            const aSnap = await getDoc(aRef);
            const bSnap = await getDoc(bRef);
            const aData = aSnap.exists() ? aSnap.data() : { inventory: [], paws: 0 };
            const bData = bSnap.exists() ? bSnap.data() : { inventory: [], paws: 0 };

            const aOffer = d.aOffer || { pets: [], paws: 0 };
            const bOffer = d.bOffer || { pets: [], paws: 0 };

            const aPetIds = (aOffer.pets||[]).map(p => p.id);
            const bPetIds = (bOffer.pets||[]).map(p => p.id);

            // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ id –¥–ª—è –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
            const receivedByA = (bOffer.pets||[]).map(p => ({ ...p, id: crypto.randomUUID(), date: new Date().toISOString() }));
            const receivedByB = (aOffer.pets||[]).map(p => ({ ...p, id: crypto.randomUUID(), date: new Date().toISOString() }));

            const newAInv = (aData.inventory||[]).filter(p => !aPetIds.includes(p.id)).concat(receivedByA);
            const newBInv = (bData.inventory||[]).filter(p => !bPetIds.includes(p.id)).concat(receivedByB);

            const newAPaws = (Number(aData.paws)||0) - Number(aOffer.paws||0) + Number(bOffer.paws||0);
            const newBPaws = (Number(bData.paws)||0) - Number(bOffer.paws||0) + Number(aOffer.paws||0);

            const batch = writeBatch(DB);
            batch.set(aRef, { inventory: newAInv, paws: newAPaws, inTrade: false, lastSeen: serverTimestamp() }, { merge: true });
            batch.set(bRef, { inventory: newBInv, paws: newBPaws, inTrade: false, lastSeen: serverTimestamp() }, { merge: true });
            batch.update(tradeRefLocal, { status: 'completed', completedAt: serverTimestamp() });
            await batch.commit();

            // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞—à –∏–≥—Ä–æ–∫
            if (window.playerId === d.playerA) { window.gameState.inventory = newAInv; window.gameState.paws = newAPaws; }
            else if (window.playerId === d.playerB) { window.gameState.inventory = newBInv; window.gameState.paws = newBPaws; }

            if (typeof savePaws === 'function') savePaws(window.gameState.paws);
            if (typeof renderInventory === 'function') renderInventory();
            if (typeof updatePawsDisplay === 'function') updatePawsDisplay();
          }
        } catch (e) {
          console.error("executeTrade err", e);
          try { await updateDoc(doc(DB, TRADES_COLL_NAME, tradeId), { status: 'cancelled' }); } catch(_) {}
        }
      }
    }, err => { console.error("trade onSnapshot err", err); });
  }

  // -------------------- üîπ –û—Ç–ø—Ä–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ --------------------
  window.sendMyOfferUpdate = async function() {
    if (!window.gameState || !window.gameState.activeTrade) return safeToast("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞.");
    try {
      const tradeRef = doc(DB, TRADES_COLL_NAME, window.gameState.activeTrade.tradeId);
      const checked = Array.from(document.querySelectorAll('.trade-pet-checkbox:checked')).map(i => i.getAttribute('data-pet-id'));
      const pawsVal = parseFloat(document.getElementById('trade-my-paws').value) || 0;
      const pets = (window.gameState.inventory || []).filter(p => checked.includes(p.id)).map(p => ({ ...p }));
      if (window.gameState.activeTrade.amInitiator) {
        await updateDoc(tradeRef, { aOffer: { pets, paws: Number(pawsVal) }, aReady: false });
      } else {
        await updateDoc(tradeRef, { bOffer: { pets, paws: Number(pawsVal) }, bReady: false });
      }
      safeToast('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.');
    } catch (e) {
      console.error("sendMyOfferUpdate err", e);
      safeToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.');
    }
  };

  // -------------------- üîπ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ --------------------
  window.setReadyStatus = async function(agree) {
    if (!window.gameState || !window.gameState.activeTrade) return safeToast("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞.");
    try {
      const tradeRef = doc(DB, TRADES_COLL_NAME, window.gameState.activeTrade.tradeId);
      if (window.gameState.activeTrade.amInitiator) await updateDoc(tradeRef, { aReady: agree });
      else await updateDoc(tradeRef, { bReady: agree });

      // –≤–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å (–æ–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ)
      const snap = await getDoc(tradeRef);
      const d = snap.exists() ? snap.data() : {};
      const myReady = window.gameState.activeTrade.amInitiator ? d.aReady : d.bReady;
      const theirReady = window.gameState.activeTrade.amInitiator ? d.bReady : d.aReady;
      let noteEl = document.getElementById('trade-wait-note');
      if (!noteEl) {
        noteEl = document.createElement('p'); noteEl.id = 'trade-wait-note';
        noteEl.className = 'text-sm text-yellow-300 mt-2';
        const panel = document.querySelector('#trade-modal .panel');
        if (panel) panel.appendChild(noteEl);
      }
      if (myReady && !theirReady) noteEl.textContent = 'üí° –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...';
      else if (!myReady) noteEl.textContent = '–í—ã –Ω–µ –≥–æ—Ç–æ–≤—ã.';
      else if (myReady && theirReady) noteEl.textContent = '–û–±–∞ –≥–æ—Ç–æ–≤—ã ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–±–º–µ–Ω...';
    } catch (e) {
      console.error("setReadyStatus err", e);
      safeToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.');
    }
  };

  // -------------------- üîπ –û—Ç–º–µ–Ω–∞ –æ–±–º–µ–Ω–∞ --------------------
  window.cancelTrade = async function() {
    if (!window.gameState || !window.gameState.activeTrade) return;
    try {
      const tradeRef = doc(DB, TRADES_COLL_NAME, window.gameState.activeTrade.tradeId);
      await updateDoc(tradeRef, { status: 'cancelled' });
    } catch (e) {
      console.error("cancelTrade err", e);
      safeToast('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –æ–±–º–µ–Ω–∞.');
    }
  };

  // -------------------- üîπ –ü–æ–ª–µ–∑–Ω—ã–π —Ö—É–∫: –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –Ω–∞—á–Ω–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å players view –µ—Å–ª–∏ –º–æ–¥–∞–ª –æ—Ç–∫—Ä—ã—Ç --------------------
  // –µ—Å–ª–∏ –º–æ–¥–∞–ª —É–∂–µ –æ—Ç–∫—Ä—ã—Ç (—Ä–µ–¥–∫–∏–π –∫–µ–π—Å), —Å—Ç–∞—Ä—Ç—É–µ–º polling
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      // –æ–±–Ω–æ–≤–∏–º –∏–≥—Ä–æ–∫–∞ online
      try { updateDoc(doc(DB, "players", window.playerId), { lastSeen: serverTimestamp() }); } catch (e) {}
    }
  });

  // ready
  console.log("Trade module loaded ‚Äî playerId:", window.playerId);
</script>
